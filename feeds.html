<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Series of utility tools to parse and manage Small Web feeds (RSS and Atom feeds)">

<title>small-web-dataset - Feeds</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="small-web-dataset - Feeds">
<meta property="og:description" content="Series of utility tools to parse and manage Small Web feeds (RSS and Atom feeds)">
<meta property="og:site-name" content="small-web-dataset">
<meta name="twitter:title" content="small-web-dataset - Feeds">
<meta name="twitter:description" content="Series of utility tools to parse and manage Small Web feeds (RSS and Atom feeds)">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">small-web-dataset</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./feeds.html">Feeds</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">small-web-dataset</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./main.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">main</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./language_detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Language Detection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feeds.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Feeds</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#feeds-db" id="toc-feeds-db" class="nav-link" data-scroll-target="#feeds-db">Feeds DB</a>
  <ul class="collapse">
  <li><a href="#connect-to-the-database" id="toc-connect-to-the-database" class="nav-link" data-scroll-target="#connect-to-the-database">Connect to the Database</a></li>
  <li><a href="#connect_feeds_db" id="toc-connect_feeds_db" class="nav-link" data-scroll-target="#connect_feeds_db">connect_feeds_db</a></li>
  <li><a href="#create-db" id="toc-create-db" class="nav-link" data-scroll-target="#create-db">Create DB</a></li>
  <li><a href="#create_articles_db" id="toc-create_articles_db" class="nav-link" data-scroll-target="#create_articles_db">create_articles_db</a></li>
  <li><a href="#create_feeds_db" id="toc-create_feeds_db" class="nav-link" data-scroll-target="#create_feeds_db">create_feeds_db</a></li>
  </ul></li>
  <li><a href="#sync-feeds" id="toc-sync-feeds" class="nav-link" data-scroll-target="#sync-feeds">Sync Feeds</a>
  <ul class="collapse">
  <li><a href="#get-feeds" id="toc-get-feeds" class="nav-link" data-scroll-target="#get-feeds">Get Feeds</a></li>
  <li><a href="#get_small_web_feeds" id="toc-get_small_web_feeds" class="nav-link" data-scroll-target="#get_small_web_feeds">get_small_web_feeds</a></li>
  <li><a href="#feed-id" id="toc-feed-id" class="nav-link" data-scroll-target="#feed-id">Feed ID</a></li>
  <li><a href="#get_feed_id_from_url" id="toc-get_feed_id_from_url" class="nav-link" data-scroll-target="#get_feed_id_from_url">get_feed_id_from_url</a></li>
  <li><a href="#process-removed-feeds-from-index" id="toc-process-removed-feeds-from-index" class="nav-link" data-scroll-target="#process-removed-feeds-from-index">Process Removed Feeds From Index</a></li>
  <li><a href="#gen_ids_index" id="toc-gen_ids_index" class="nav-link" data-scroll-target="#gen_ids_index">gen_ids_index</a></li>
  <li><a href="#process_removed_feed_from_index" id="toc-process_removed_feed_from_index" class="nav-link" data-scroll-target="#process_removed_feed_from_index">process_removed_feed_from_index</a></li>
  <li><a href="#download-a-feed" id="toc-download-a-feed" class="nav-link" data-scroll-target="#download-a-feed">Download a Feed</a></li>
  <li><a href="#download_feed" id="toc-download_feed" class="nav-link" data-scroll-target="#download_feed">download_feed</a></li>
  <li><a href="#sync-all-the-feeds-from-the-index" id="toc-sync-all-the-feeds-from-the-index" class="nav-link" data-scroll-target="#sync-all-the-feeds-from-the-index">Sync all the feeds from the index</a></li>
  <li><a href="#sync_feeds" id="toc-sync_feeds" class="nav-link" data-scroll-target="#sync_feeds">sync_feeds</a></li>
  </ul></li>
  <li><a href="#language-detection" id="toc-language-detection" class="nav-link" data-scroll-target="#language-detection">Language Detection</a>
  <ul class="collapse">
  <li><a href="#detect_language" id="toc-detect_language" class="nav-link" data-scroll-target="#detect_language">detect_language</a></li>
  <li><a href="#tests-3" id="toc-tests-3" class="nav-link" data-scroll-target="#tests-3">Tests</a></li>
  </ul></li>
  <li><a href="#parse-a-local-feed" id="toc-parse-a-local-feed" class="nav-link" data-scroll-target="#parse-a-local-feed">Parse a Local Feed</a>
  <ul class="collapse">
  <li><a href="#parse_feed" id="toc-parse_feed" class="nav-link" data-scroll-target="#parse_feed">parse_feed</a></li>
  </ul></li>
  <li><a href="#sync-feeds-db-from-local-cache" id="toc-sync-feeds-db-from-local-cache" class="nav-link" data-scroll-target="#sync-feeds-db-from-local-cache">Sync Feeds DB from Local Cache</a>
  <ul class="collapse">
  <li><a href="#sync_feeds_db_from_cache" id="toc-sync_feeds_db_from_cache" class="nav-link" data-scroll-target="#sync_feeds_db_from_cache">sync_feeds_db_from_cache</a></li>
  <li><a href="#sync_feeds-1" id="toc-sync_feeds-1" class="nav-link" data-scroll-target="#sync_feeds-1">sync_feeds</a></li>
  <li><a href="#update-the-language-of-the-feeds" id="toc-update-the-language-of-the-feeds" class="nav-link" data-scroll-target="#update-the-language-of-the-feeds">Update the language of the feeds</a></li>
  <li><a href="#get_articles_lang_per_feeds" id="toc-get_articles_lang_per_feeds" class="nav-link" data-scroll-target="#get_articles_lang_per_feeds">get_articles_lang_per_feeds</a></li>
  <li><a href="#update-the-feeds-table-with-the-new-languages" id="toc-update-the-feeds-table-with-the-new-languages" class="nav-link" data-scroll-target="#update-the-feeds-table-with-the-new-languages">Update the feeds table with the new languages</a></li>
  <li><a href="#update_feeds_with_languages" id="toc-update_feeds_with_languages" class="nav-link" data-scroll-target="#update_feeds_with_languages">update_feeds_with_languages</a></li>
  </ul></li>
  <li><a href="#clean-small-web-index" id="toc-clean-small-web-index" class="nav-link" data-scroll-target="#clean-small-web-index">Clean Small Web Index</a>
  <ul class="collapse">
  <li><a href="#get_non_english_feeds" id="toc-get_non_english_feeds" class="nav-link" data-scroll-target="#get_non_english_feeds">get_non_english_feeds</a></li>
  <li><a href="#get_cleaned_small_web_index" id="toc-get_cleaned_small_web_index" class="nav-link" data-scroll-target="#get_cleaned_small_web_index">get_cleaned_small_web_index</a></li>
  </ul></li>
  <li><a href="#validate-small-web-index-file" id="toc-validate-small-web-index-file" class="nav-link" data-scroll-target="#validate-small-web-index-file">Validate Small Web Index File</a>
  <ul class="collapse">
  <li><a href="#diff_index_file" id="toc-diff_index_file" class="nav-link" data-scroll-target="#diff_index_file">diff_index_file</a></li>
  <li><a href="#is_feed_english" id="toc-is_feed_english" class="nav-link" data-scroll-target="#is_feed_english">is_feed_english</a></li>
  <li><a href="#validate_new_index_file" id="toc-validate_new_index_file" class="nav-link" data-scroll-target="#validate_new_index_file">validate_new_index_file</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/fgiasson/small-web-dataset/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Feeds</h1>
</div>

<div>
  <div class="description">
    Series of utility tools to parse and manage Small Web feeds (RSS and Atom feeds)
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="imports" class="level2">
<h2 class="anchored" data-anchor-id="imports">Imports</h2>
</section>
<section id="feeds-db" class="level2">
<h2 class="anchored" data-anchor-id="feeds-db">Feeds DB</h2>
<p>We will want to save diffent kind of information related to the feeds we process. We will save that information locally in a lightweigth SQLite database. Here are different kind of things we will want to save:</p>
<ul>
<li>feed’s ID (private key)</li>
<li>its language</li>
<li>number of entries</li>
<li>last time we downloaded it</li>
<li>type of feed</li>
<li>feed’s URL</li>
<li>feed’s title</li>
<li>feed’s description</li>
<li>feed’s author</li>
</ul>
<section id="connect-to-the-database" class="level3">
<h3 class="anchored" data-anchor-id="connect-to-the-database">Connect to the Database</h3>
<hr>
</section>
<section id="connect_feeds_db" class="level3">
<h3 class="anchored" data-anchor-id="connect_feeds_db">connect_feeds_db</h3>
<blockquote class="blockquote">
<pre><code> connect_feeds_db ()</code></pre>
</blockquote>
<p>Connect to the feeds database</p>
</section>
<section id="create-db" class="level3">
<h3 class="anchored" data-anchor-id="create-db">Create DB</h3>
<hr>
</section>
<section id="create_articles_db" class="level3">
<h3 class="anchored" data-anchor-id="create_articles_db">create_articles_db</h3>
<blockquote class="blockquote">
<pre><code> create_articles_db (conn:sqlite3.Connection)</code></pre>
</blockquote>
<p>Create the articles database</p>
<hr>
</section>
<section id="create_feeds_db" class="level3">
<h3 class="anchored" data-anchor-id="create_feeds_db">create_feeds_db</h3>
<blockquote class="blockquote">
<pre><code> create_feeds_db (conn:sqlite3.Connection)</code></pre>
</blockquote>
<p>Create the feeds database</p>
</section>
</section>
<section id="sync-feeds" class="level2">
<h2 class="anchored" data-anchor-id="sync-feeds">Sync Feeds</h2>
<p>The local feeds needs to be synchroninzed with the Small Web index. Most of them will be new, but it is possible that some of the previous feeds gets removed from the feeds index. In that case, we have to remove the feed from the local system and the SQL database. The process is as fellow:</p>
<ol type="1">
<li>check if some of the feeds got removed from the index
<ol type="1">
<li>if so, remove the feed from the local system</li>
<li>remove the feed from the SQL database</li>
</ol></li>
<li>if the feed is not already on the file system, create a unique folder name for each of the new feed</li>
<li>create a <code>DDMMYYYY</code> folder under the ID of the feed in the <code>FEEDS_PATH</code> folder</li>
<li>download the feed’s file in that folder</li>
</ol>
<p>The local folder and file structure should be:</p>
<ul>
<li><code>FEEDS_PATH</code>
<ul>
<li><code>feed_unique_folder</code>
<ul>
<li><code>DDMMYYYY</code>
<ul>
<li><code>feed.xml</code></li>
</ul></li>
<li><code>DDMMYYYY</code>
<ul>
<li><code>feed.xml</code></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<section id="get-feeds" class="level3">
<h3 class="anchored" data-anchor-id="get-feeds">Get Feeds</h3>
<p>The first step is to get le list of feeds for the Small Web. That list is available from the <a href="https://github.com/kagisearch/smallweb/blob/main/smallweb.txt">Kagi Small Web index</a>. Then for each of those feed in the list, we will download and save them locally in the <code>FEEDS_PATH</code> folder.</p>
<hr>
</section>
<section id="get_small_web_feeds" class="level3">
<h3 class="anchored" data-anchor-id="get_small_web_feeds">get_small_web_feeds</h3>
<blockquote class="blockquote">
<pre><code> get_small_web_feeds ()</code></pre>
</blockquote>
<p>Get smallweb feeds from KagiSearch’s github repository</p>
<section id="tests" class="level4">
<h4 class="anchored" data-anchor-id="tests">Tests</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(get_small_web_feeds()) <span class="op">&gt;</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="feed-id" class="level3">
<h3 class="anchored" data-anchor-id="feed-id">Feed ID</h3>
<p>We build the unique ID of a feed from its URL. We use the following steps:</p>
<ol type="1">
<li>For every character, if it not an alpha numeric character, we replace it with a <code>-</code></li>
</ol>
<p>This method is used to make sure we can use the ID to create files and directories on the local file system, as a private key in the BD, while keeping the ID readable. It could duplicate IDs if a non-alpha numeric character is the only differenciator of a URL, in which case both will be replaced by a <code>-</code> and the IDs will clash. But this is unlikely in short term and is good enough for now.</p>
<hr>
</section>
<section id="get_feed_id_from_url" class="level3">
<h3 class="anchored" data-anchor-id="get_feed_id_from_url">get_feed_id_from_url</h3>
<blockquote class="blockquote">
<pre><code> get_feed_id_from_url (url:str)</code></pre>
</blockquote>
<p>Get the feed id from a feed url</p>
<section id="tests-1" class="level4">
<h4 class="anchored" data-anchor-id="tests-1">Tests</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> get_feed_id_from_url(<span class="st">'https://example.com/feed.xml'</span>) <span class="op">==</span> <span class="st">'https---example-com-feed-xml'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="process-removed-feeds-from-index" class="level3">
<h3 class="anchored" data-anchor-id="process-removed-feeds-from-index">Process Removed Feeds From Index</h3>
<p>It is possible that previously downloaded feeds get removed from the Small Web index. In this case, we get the latest version of the Small Web index, detect which was was removed, and remove it from the file system and the SQL database.</p>
<hr>
</section>
<section id="gen_ids_index" class="level3">
<h3 class="anchored" data-anchor-id="gen_ids_index">gen_ids_index</h3>
<blockquote class="blockquote">
<pre><code> gen_ids_index (index:list)</code></pre>
</blockquote>
<p>Return a list of IDs of the feeds in the index</p>
<section id="tests-2" class="level4">
<h4 class="anchored" data-anchor-id="tests-2">Tests</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> [<span class="st">'https://example.com/feed.xml'</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>index2 <span class="op">=</span> gen_ids_index(index)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> index2 <span class="op">==</span> [<span class="st">'https---example-com-feed-xml'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="process_removed_feed_from_index" class="level3">
<h3 class="anchored" data-anchor-id="process_removed_feed_from_index">process_removed_feed_from_index</h3>
<blockquote class="blockquote">
<pre><code> process_removed_feed_from_index (index:list)</code></pre>
</blockquote>
<p>Process all the feeds that got removed from the SmallWeb index</p>
</section>
<section id="download-a-feed" class="level3">
<h3 class="anchored" data-anchor-id="download-a-feed">Download a Feed</h3>
<hr>
</section>
<section id="download_feed" class="level3">
<h3 class="anchored" data-anchor-id="download_feed">download_feed</h3>
<blockquote class="blockquote">
<pre><code> download_feed (url:str)</code></pre>
</blockquote>
<p>Download a feed from a given url</p>
</section>
<section id="sync-all-the-feeds-from-the-index" class="level3">
<h3 class="anchored" data-anchor-id="sync-all-the-feeds-from-the-index">Sync all the feeds from the index</h3>
<hr>
</section>
<section id="sync_feeds" class="level3">
<h3 class="anchored" data-anchor-id="sync_feeds">sync_feeds</h3>
<blockquote class="blockquote">
<pre><code> sync_feeds ()</code></pre>
</blockquote>
<p>Sync all feeds from smallweb</p>
</section>
</section>
<section id="language-detection" class="level2">
<h2 class="anchored" data-anchor-id="language-detection">Language Detection</h2>
<p>We use the library <a href="https://pypi.org/project/langdetect/">langdetect</a> to detect the language of a feed. We use the <code>detect</code> method of the library. We tried other avenues like Hugging Face madels, but the language detection performance and the processing performaces with not justifying the additional complexity for now (results were worse and much slower). You can check the file <code>01_language_detection.ipynb</code> for more details.</p>
<hr>
<section id="detect_language" class="level3">
<h3 class="anchored" data-anchor-id="detect_language">detect_language</h3>
<blockquote class="blockquote">
<pre><code> detect_language (text:str)</code></pre>
</blockquote>
<p>Detect the language of a given text</p>
</section>
<section id="tests-3" class="level3">
<h3 class="anchored" data-anchor-id="tests-3">Tests</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'This is a test'</span>) <span class="op">==</span> <span class="st">''</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'This is a test'</span> <span class="op">*</span> <span class="dv">128</span>) <span class="op">==</span> <span class="st">'en'</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'Ceci est un test'</span>) <span class="op">==</span> <span class="st">''</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'Ceci est un test'</span> <span class="op">*</span> <span class="dv">128</span>) <span class="op">==</span> <span class="st">'fr'</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'これはテストです'</span>) <span class="op">==</span> <span class="st">''</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'これはテストです'</span> <span class="op">*</span> <span class="dv">128</span>) <span class="op">==</span> <span class="st">'ja'</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'이것은 테스트입니다'</span>) <span class="op">==</span> <span class="st">''</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'이것은 테스트입니다'</span> <span class="op">*</span> <span class="dv">128</span>) <span class="op">==</span> <span class="st">'ko'</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;This is a test'</span>) <span class="op">==</span> <span class="st">''</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> detect_language(<span class="st">'&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;This is a test'</span> <span class="op">*</span> <span class="dv">128</span>) <span class="op">==</span> <span class="st">'en'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="parse-a-local-feed" class="level2">
<h2 class="anchored" data-anchor-id="parse-a-local-feed">Parse a Local Feed</h2>
<p>For any given feed URL, let’s parse the local feed we downloaded for it and return an internal dictionary that represents it, whatever if it is a RSS or Atom feed. The internal representation of an small web article if represented by a <code>namedtuple</code></p>
<hr>
<section id="parse_feed" class="level3">
<h3 class="anchored" data-anchor-id="parse_feed">parse_feed</h3>
<blockquote class="blockquote">
<pre><code> parse_feed (url:str, feed_path:str=None)</code></pre>
</blockquote>
<p>Parse a feed from a given path and url</p>
</section>
</section>
<section id="sync-feeds-db-from-local-cache" class="level2">
<h2 class="anchored" data-anchor-id="sync-feeds-db-from-local-cache">Sync Feeds DB from Local Cache</h2>
<p>We do download all and every feeds locally and save them in a time stamped folder of the day where they were downloaded. We proceed that way such that we don’t have to redownload all the feeds every time we change an internal process that requires us to parse the feeds again. We can just parse the local cache of the feeds we downloaded.</p>
<p>The synchronization occurs by simply creating one transaction per feed using INSERT OR INGORE which appears to be the fastest way to only add the new feeds and ignore the one that are already in the DB. This is also by far the simplest logic to implement and to reason about.</p>
<p>If the database is empty, then it will be fully populated with the cache of the provided DDMMYYY as input.</p>
<hr>
<section id="sync_feeds_db_from_cache" class="level3">
<h3 class="anchored" data-anchor-id="sync_feeds_db_from_cache">sync_feeds_db_from_cache</h3>
<blockquote class="blockquote">
<pre><code> sync_feeds_db_from_cache (ddmmyyyy:str='20092023')</code></pre>
</blockquote>
<p>Sync the feeds database from the cache. The cache by default to use is the one from today. It is possible to use a different cache by passing a different date in the format DDMMYYYY</p>
<hr>
</section>
<section id="sync_feeds-1" class="level3">
<h3 class="anchored" data-anchor-id="sync_feeds-1">sync_feeds</h3>
<blockquote class="blockquote">
<pre><code> sync_feeds ()</code></pre>
</blockquote>
<p>Sync all feeds from smallweb</p>
</section>
<section id="update-the-language-of-the-feeds" class="level3">
<h3 class="anchored" data-anchor-id="update-the-language-of-the-feeds">Update the language of the feeds</h3>
<p>The next step is to update the primary language of a feed. This is done by checking what is the highest number of articles with a certain language.</p>
<p>What the following SQLite query does, it to group by language and count the number of articles for each language. Then we order by the count in descending order and we limit the result to 1. This way, we get the language with the highest number of articles.</p>
<p>We have to take that result and to update the <code>feeds</code> table with the new language.</p>
<p>Note: it doesn’t seems possible to do that in SQLite directly, if I am missing some feature of the query language, please propose a better solution and submit a PR.</p>
<hr>
</section>
<section id="get_articles_lang_per_feeds" class="level3">
<h3 class="anchored" data-anchor-id="get_articles_lang_per_feeds">get_articles_lang_per_feeds</h3>
<blockquote class="blockquote">
<pre><code> get_articles_lang_per_feeds ()</code></pre>
</blockquote>
<p>Get the count of articles per language per feed</p>
</section>
<section id="update-the-feeds-table-with-the-new-languages" class="level3">
<h3 class="anchored" data-anchor-id="update-the-feeds-table-with-the-new-languages">Update the feeds table with the new languages</h3>
<p>The next step is to take those results and to update the <code>feeds</code> table with the new language.</p>
<hr>
</section>
<section id="update_feeds_with_languages" class="level3">
<h3 class="anchored" data-anchor-id="update_feeds_with_languages">update_feeds_with_languages</h3>
<blockquote class="blockquote">
<pre><code> update_feeds_with_languages (rows)</code></pre>
</blockquote>
<p>Update the feeds database with the language of the feed</p>
</section>
</section>
<section id="clean-small-web-index" class="level2">
<h2 class="anchored" data-anchor-id="clean-small-web-index">Clean Small Web Index</h2>
<p>This utility function is used to remove all the feeds that have been tagged as non-english. For the moment, only the ones that have been tagged with a non-english language will be added, the ones that the current heuristic couldn’t determine the core language will be left in the index. Further work will be required for them.</p>
<hr>
<section id="get_non_english_feeds" class="level3">
<h3 class="anchored" data-anchor-id="get_non_english_feeds">get_non_english_feeds</h3>
<blockquote class="blockquote">
<pre><code> get_non_english_feeds ()</code></pre>
</blockquote>
<p>Return the list of non-english feeds URL</p>
<p>Next step is to remove the feeds URLs from the Small Web index.</p>
<hr>
</section>
<section id="get_cleaned_small_web_index" class="level3">
<h3 class="anchored" data-anchor-id="get_cleaned_small_web_index">get_cleaned_small_web_index</h3>
<blockquote class="blockquote">
<pre><code> get_cleaned_small_web_index ()</code></pre>
</blockquote>
<p>Return the cleaned small web index</p>
</section>
</section>
<section id="validate-small-web-index-file" class="level2">
<h2 class="anchored" data-anchor-id="validate-small-web-index-file">Validate Small Web Index File</h2>
<p>One thing that needs to be done is to check every incoming PR of the <a href="https://github.com/kagisearch/smallweb">smallweb</a> repository to see if the new proposed feeds from the contributors are valid or not. Do enabled this in a PR check, we will add a few functions here to validate a new proposed index file against the one of the <code>main</code> branch.</p>
<hr>
<section id="diff_index_file" class="level3">
<h3 class="anchored" data-anchor-id="diff_index_file">diff_index_file</h3>
<blockquote class="blockquote">
<pre><code> diff_index_file (new_index_file:str)</code></pre>
</blockquote>
<p>Diff an input index file with the one currently on the <code>main</code> branch of the SmallWeb repository</p>
<p>Now that we have the list of new feeds from what is currently in the index, the next step is to make sure that those feeds are valid according to the Kagi Small Web index guidelines. The first thing we validate is to make sure the feed is an English feed. Other validation checks could be added in the future.</p>
<hr>
</section>
<section id="is_feed_english" class="level3">
<h3 class="anchored" data-anchor-id="is_feed_english">is_feed_english</h3>
<blockquote class="blockquote">
<pre><code> is_feed_english (url:str)</code></pre>
</blockquote>
<p>Validate a feed from a given url is an English feed</p>
<p>Given a new index file, the validate function will check which are the new feeds, will get and parse each of them to deterine their validity. An empty list will be returned if all the feeds are valid, otherwise a list of the invalid feeds will be returned.</p>
<hr>
</section>
<section id="validate_new_index_file" class="level3">
<h3 class="anchored" data-anchor-id="validate_new_index_file">validate_new_index_file</h3>
<blockquote class="blockquote">
<pre><code> validate_new_index_file (new_index_file:str)</code></pre>
</blockquote>
<p>Validate a new index file by checking that all the feeds are in English. Returns an empty list if the new feeds are all valid. Returns a list of URLs with each of the feed that are not valid.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>